#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const screenshotsDir = path.join(__dirname, '..', 'static', 'img', 'screenshots');
const outDir = path.join(__dirname, '..', 'src', 'data');
const outFile = path.join(outDir, 'screenshots.js');

function humanize(filename) {
  const name = filename.replace(/\.[^/.]+$/, '');
  return name.replace(/[-_]+/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
}

function gather() {
  let list = [];
  if (fs.existsSync(screenshotsDir)) {
    const files = fs.readdirSync(screenshotsDir).filter((f) => {
      const ext = path.extname(f).toLowerCase();
      return ['.png', '.jpg', '.jpeg', '.webp', '.gif', '.svg'].includes(ext);
    }).sort();

    list = files.map((f) => ({ src: `/img/screenshots/${f}`, alt: humanize(f) }));
  }
  return list;
}

function write(list) {
  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
  const content = `// This file is auto-generated by scripts/generate-screenshots.js\n// Do not edit by hand. Add images to static/img/screenshots/ and run the generator.\n\nexport default ${JSON.stringify(list, null, 2)};\n`;

  // Avoid writing file if nothing changed
  if (fs.existsSync(outFile)) {
    const prev = fs.readFileSync(outFile, 'utf8');
    if (prev === content) {
      return false; // no change
    }
  }

  fs.writeFileSync(outFile, content, 'utf8');
  console.log(`Wrote ${list.length} screenshots to ${path.relative(process.cwd(), outFile)}`);
  return true;
}

function generate() {
  const list = gather();
  const changed = write(list);
  return { list, changed };
}

if (process.argv.includes('--watch')) {
  // Lazy load chokidar only in watch mode
  const chokidar = require('chokidar');
  console.log('Watching', screenshotsDir);

  // initial generation
  generate();

  const watcher = chokidar.watch(screenshotsDir, { ignoreInitial: true, depth: 1 });
  const onChange = (evt, file) => {
    console.log(evt, file || '');
    const { changed } = generate();
    if (changed) {
      console.log('Regenerated screenshots data.');
    }
  };

  watcher.on('add', (p) => onChange('add', p));
  watcher.on('change', (p) => onChange('change', p));
  watcher.on('unlink', (p) => onChange('unlink', p));

  // graceful exit
  process.on('SIGINT', () => {
    watcher.close();
    process.exit(0);
  });
} else {
  const { changed } = generate();
  process.exit(changed ? 0 : 0);
}
